<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cbus Assistant Pro</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 15px; background: #f0f4f7; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #005596; text-align: center; margin-top: 0; }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-row div { flex: 1; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 3px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .form-box { background: #f9f9f9; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 15px; }
        .form-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; }
        .form-item:last-child { border-bottom: none; }
        .form-item input { width: auto; margin-right: 10px; }
        button { width: 100%; padding: 16px; background: #005596; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #003d6b; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; color: #005596; min-height: 1.2em; font-size: 14px; }
        #auth-screen { text-align: center; padding: 40px 0; }
    </style>
</head>
<body>

<div id="auth-screen" class="container">
    <h2>üîí Secure Entry</h2>
    <input type="password" id="pin-input" inputmode="numeric" placeholder="Enter PIN" maxlength="4" style="text-align:center; width: 60%;">
    <button onclick="checkPin()">Unlock</button>
</div>

<div id="main-content" class="container" style="display:none;">
    <h2>üèóÔ∏è Cbus Assistant</h2>

    <div class="input-row">
        <div><label>Given Name(s)</label><input type="text" id="given_names" placeholder="John"></div>
        <div><label>Family Name</label><input type="text" id="family_name" placeholder="Doe"></div>
    </div>

    <div class="input-row">
        <div><label>Member Number</label><input type="text" id="member_no"></div>
        <div><label>Date of Birth</label><input type="date" id="dob"></div>
    </div>

    <div class="input-row">
        <div><label>TFN</label><input type="text" id="tfn" inputmode="numeric"></div>
        <div><label>Mobile</label><input type="tel" id="mobile"></div>
    </div>

    <div><label>Residential Address</label><input type="text" id="address" placeholder="Street Number & Name"></div>
    
    <div class="input-row" style="margin-top:10px;">
        <div style="flex:2;"><label>Suburb</label><input type="text" id="suburb"></div>
        <div><label>State</label><select id="state"><option>VIC</option><option>NSW</option><option>QLD</option><option>WA</option><option>SA</option><option>TAS</option><option>ACT</option><option>NT</option></select></div>
        <div><label>Postcode</label><input type="text" id="postcode"></div>
    </div>

    <div class="form-box">
        <label>Select Forms to Bundle:</label>
        <div id="form-list">
            <label class="form-item"><input type="checkbox" value="C-join-industry-form.pdf"> Join Industry Form (C)</label>
            <label class="form-item"><input type="checkbox" value="join-industry.pdf"> Join Industry (Standard)</label>
            <label class="form-item"><input type="checkbox" value="C-super-withdrawal-form.pdf"> Super Withdrawal (C)</label>
            <label class="form-item"><input type="checkbox" value="super-withdrawal-form.pdf"> Super Withdrawal (Standard)</label>
            <label class="form-item"><input type="checkbox" value="combine-your-super.pdf"> Combine Your Super</label>
            <label class="form-item"><input type="checkbox" value="C-Binding-Death-Benefit-Nomination-Form.pdf"> Binding Death Nom (C)</label>
            <label class="form-item"><input type="checkbox" value="binding-death-nomination.pdf"> Binding Death Nom (Standard)</label>
            <label class="form-item"><input type="checkbox" value="C-Change-Insurance-Form-Industry-Super.pdf"> Change Insurance (C)</label>
            <label class="form-item"><input type="checkbox" value="C-Application-to-Transfer-Existing-Insurance-cover-transfer-form.pdf"> Transfer Insurance Cover (C)</label>
            <label class="form-item"><input type="checkbox" value="application-transfer-existing-insurance-cover.pdf"> Transfer Insurance (Standard)</label>
            <label class="form-item"><input type="checkbox" value="i-want-my-super-paid-into-media-super.pdf"> Media Super Pay-In</label>
        </div>
    </div>

    <button id="download-btn" onclick="generateZip()">üöÄ Download All as ZIP</button>
    <div id="status"></div>
</div>

<script>
    const PIN = "1234";

    function checkPin() {
        if(document.getElementById('pin-input').value === PIN) {
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('main-content').style.display='block';
        } else { alert("Wrong PIN"); }
    }

    async function generateZip() {
        const selected = Array.from(document.querySelectorAll('#form-list input:checked'));
        if (selected.length === 0) return alert("Select at least one form!");

        const status = document.getElementById('status');
        const btn = document.getElementById('download-btn');
        const zip = new JSZip();
        
        status.innerText = "‚è≥ Starting process...";
        btn.disabled = true;

        try {
            for (let item of selected) {
                const fileName = item.value;
                status.innerText = `‚úçÔ∏è Filling: ${fileName}`;
                
                // 1. Fetch File with Error Check
                const response = await fetch(`./forms/${fileName}`);
                if (!response.ok) {
                    console.error(`Failed to load: ${fileName}`);
                    continue; // Skip this file and move to next
                }
                
                const bytes = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(bytes);
                const form = pdfDoc.getForm();

                // 2. Prepare Data
                const dobVal = document.getElementById('dob').value;
                let dD="", dM="", dY=""; 
                if(dobVal){ 
                    const [year, month, day] = dobVal.split('-');
                    dD = day; dM = month; dY = year;
                }

                const tfn = document.getElementById('tfn').value.replace(/\s/g,'');
                const t1=tfn.substring(0,3), t2=tfn.substring(3,6), t3=tfn.substring(6,9);

                const data = {
                    'Given names': document.getElementById('given_names').value,
                    'Family name': document.getElementById('family_name').value,
                    'Member number': document.getElementById('member_no').value,
                    'Date of birth day': dD, 'Date of birth month': dM, 'Date of birth year': dY,
                    'TFN1': t1, 'TFN2': t2, 'TFN3': t3,
                    'Residential address (compulsory)': document.getElementById('address').value,
                    'Suburb/town': document.getElementById('suburb').value,
                    'State': document.getElementById('state').value,
                    'Postcode': document.getElementById('postcode').value,
                    'Telephone mobile': document.getElementById('mobile').value
                };

                // 3. Robust Field Filling
                Object.keys(data).forEach(key => {
                    try { 
                        const field = form.getTextField(key);
                        if (field) field.setText(data[key]); 
                    } catch(e){
                        // Silently skip if field name doesn't match this specific PDF
                    }
                });

                const savedBytes = await pdfDoc.save();
                zip.file(`Filled_${fileName}`, savedBytes);
            }

            status.innerText = "üì¶ Creating ZIP file...";
            const content = await zip.generateAsync({type:"blob"});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            const lName = document.getElementById('family_name').value || "Cbus";
            link.download = `${lName}_Forms.zip`;
            link.click();
            
            status.innerText = "‚úÖ Done! Check your Downloads.";
        } catch (err) {
            console.error(err);
            status.innerText = "‚ùå Error: " + err.message;
        } finally {
            btn.disabled = false;
        }
    }
</script>
</body>
</html>