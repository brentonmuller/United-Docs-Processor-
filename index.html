<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cbus Assistant Pro v1.7</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; background: #f0f4f7; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .version-badge { float: right; background: #c62828; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        h2 { color: #005596; text-align: center; margin-top: 10px; }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .input-row div { flex: 1; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 3px; color: #666; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .form-box { background: #f9f9f9; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 15px; }
        .form-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; }
        .form-item input { width: auto; margin-right: 10px; }
        button { width: 100%; padding: 16px; background: #005596; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; color: #005596; font-size: 14px; }
        #auth-screen { text-align: center; padding: 40px 0; }
    </style>
</head>
<body>

<div id="auth-screen" class="container">
    <span class="version-badge">v1.7</span>
    <h2>üîí Secure Entry</h2>
    <input type="password" id="pin-input" inputmode="numeric" placeholder="Enter PIN" maxlength="4" style="text-align:center; width: 60%;">
    <button onclick="checkPin()">Unlock</button>
</div>

<div id="main-content" class="container" style="display:none;">
    <span class="version-badge" style="background: #2e7d32;">v1.7 ACTIVE</span>
    <h2>üèóÔ∏è Cbus Assistant</h2>

    <div class="input-row">
        <div><label>Given Name(s)</label><input type="text" id="given_names"></div>
        <div><label>Family Name</label><input type="text" id="family_name"></div>
    </div>

    <div class="input-row">
        <div><label>Member Number</label><input type="text" id="member_no"></div>
        <div><label>Date of Birth</label><input type="date" id="dob"></div>
    </div>

    <div class="input-row">
        <div><label>TFN</label><input type="text" id="tfn" inputmode="numeric"></div>
        <div><label>Mobile</label><input type="tel" id="mobile"></div>
    </div>

    <div><label>Email Address</label><input type="email" id="email"></div>

    <div style="margin-top:10px;"><label>Street Address (Number & Street)</label><input type="text" id="address"></div>
    
    <div class="input-row" style="margin-top:10px;">
        <div style="flex:2;"><label>Suburb</label><input type="text" id="suburb"></div>
        <div><label>State</label><select id="state"><option>VIC</option><option>NSW</option><option>QLD</option><option>WA</option><option>SA</option><option>TAS</option><option>ACT</option><option>NT</option></select></div>
        <div><label>Postcode</label><input type="text" id="postcode"></div>
    </div>

    <div class="form-box">
        <label>Select Forms to Bundle:</label>
        <div id="form-list">
            <label class="form-item"><input type="checkbox" value="C-join-industry-form.pdf"> Join Industry Form (C)</label>
            <label class="form-item"><input type="checkbox" value="join-industry.pdf"> Join Industry (Standard)</label>
            <label class="form-item"><input type="checkbox" value="combine-your-super.pdf"> Combine Your Super</label>
            <label class="form-item"><input type="checkbox" value="i-want-my-super-paid-into-media-super.pdf"> Media Super Pay-In</label>
            </div>
    </div>

    <button id="download-btn" onclick="generateZip()">üöÄ Download Fixed v1.7 Bundle</button>
    <div id="status"></div>
</div>

<script>
    const PIN = "1234";
    function checkPin() {
        if(document.getElementById('pin-input').value === PIN) {
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('main-content').style.display='block';
        } else { alert("Wrong PIN"); }
    }

    async function generateZip() {
        const selected = Array.from(document.querySelectorAll('#form-list input:checked'));
        if (selected.length === 0) return alert("Select a form!");

        const status = document.getElementById('status');
        const zip = new JSZip();
        
        try {
            for (let item of selected) {
                const fileName = item.value;
                status.innerText = `üîÑ Hard-Mapping: ${fileName}`;
                
                const response = await fetch(`./forms/${fileName}`);
                const bytes = await response.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(bytes);
                const form = pdfDoc.getForm();

                const dobVal = document.getElementById('dob').value;
                let dD="", dM="", dY=""; if(dobVal) [dY, dM, dD] = dobVal.split('-');
                const tfn = document.getElementById('tfn').value.replace(/\s/g,'');

                // THE "TRIPLE-STRIKE" MAP
                // We map to every possible variation found in the forensic audit
                const forensicMap = {
                    // ADDRESS FIXES 
                    'Residential address (compulsory)': document.getElementById('address').value,
                    'Residential address': document.getElementById('address').value,
                    'Street address': document.getElementById('address').value,
                    
                    // NAMES [cite: 3, 302, 3499]
                    'Given name(s)': document.getElementById('given_names').value,
                    'Given names': document.getElementById('given_names').value,
                    'Family name': document.getElementById('family_name').value,

                    // MEMBER NUMBERS [cite: 3, 302, 3499]
                    'Cbus Super member number, if known': document.getElementById('member_no').value,
                    'Media Super member number, if known': document.getElementById('member_no').value,
                    'Media Super member number': document.getElementById('member_no').value,
                    'Member number': document.getElementById('member_no').value,

                    // CONTACTS 
                    'Mobile': document.getElementById('mobile').value,
                    'Mobile phone': document.getElementById('mobile').value,
                    'Telephone mobile': document.getElementById('mobile').value,
                    'Email address': document.getElementById('email').value,
                    'Email address (providing your email means you give us permission to use it)': document.getElementById('email').value,

                    // LOCATION [cite: 3, 302]
                    'Suburb/town': document.getElementById('suburb').value,
                    'State': document.getElementById('state').value,
                    'Postcode': document.getElementById('postcode').value,

                    // TFN & DOB [cite: 3, 4]
                    'Date of birth day': dD, 'Date of birth month': dM, 'Date of birth year': dY,
                    'TFN1': tfn.substring(0,3), 'TFN2': tfn.substring(3,6), 'TFN3': tfn.substring(6,9),
                    'Tax file number': tfn
                };

                // Apply logic
                Object.keys(forensicMap).forEach(key => {
                    try {
                        const field = form.getTextField(key);
                        field.setText(forensicMap[key]);
                    } catch(e) {}
                });

                const savedBytes = await pdfDoc.save();
                zip.file(`Filled_${fileName}`, savedBytes);
            }

            status.innerText = "üì¶ Bundle Ready...";
            const content = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `Cbus_v1.7_Final_Fix.zip`;
            link.click();
            status.innerText = "‚úÖ Done! v1.7 Applied.";
        } catch (err) {
            status.innerText = "‚ùå Error: " + err.message;
        }
    }
</script>
</body>
</html>